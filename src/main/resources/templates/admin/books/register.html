<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
  <title>ë¶ë§¤ë‹ˆì €</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    @keyframes fade {
      0% {
        opacity: 0.4;
      }
      100% {
        opacity: 1;
      }
    }

    header{position: relative;}
    header>.bg_lnb{
      display: none;
      position: absolute;
      left: 0;
      top: 72px;
      width: 100%;
      height: 120px;
      background-color: rgba(59, 130, 246, 0.06);
      border-top: 3px solid #3b82f6;
      border-bottom: 1px solid #bfdbfe;
      animation: fade 0.3s;
    }

    .container{
      position: relative;
    }
    .container>nav{
      position: absolute;
      right: 0;
      top: 32px;
    }

    .container>nav .lnb{
      display: none;
      margin-top: 32px;
      animation: fade 0.3s;
    }
    .container>nav .lnb>li>a{
      display: block;
      height: 30px;
      line-height: 30px;

    }
    .container>nav .lnb>li>a:hover{
      color: #fff;
      font-weight: 800;
      background-color: #3b82f6;
    }

    .error-message {
      color: #dc2626;
      font-size: 0.875rem;
      margin-top: 0.25rem;
    }

  </style>
</head>
<body class="bg-gray-50">
<!-- í—¤ë” -->
<header th:replace="~{fragments/header :: siteHeader}"></header>

<!-- ë³¸ë¬¸ -->
<main class="max-w-screen-xl mx-auto px-4 py-8">
  <h2 class="text-2xl font-bold mb-6">ğŸ“š ë„ì„œë“±ë¡</h2>

  <!-- ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ -->
  <div th:if="${message}" class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4" role="alert">
    <span class="block sm:inline" th:text="${message}"></span>
  </div>

  <!-- ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ -->
  <div th:if="${errorMessage}" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4" role="alert">
    <span class="block sm:inline" th:text="${errorMessage}"></span>
  </div>

  <form th:action="@{/admin/v1/books/register}" method="post" class="bg-white p-6 rounded border border-gray-300 shadow space-y-6">

    <!-- ì¹´í…Œê³ ë¦¬ -->
    <div class="grid md:grid-cols-3 gap-4">
      <div>
        <label class="block font-medium mb-1">ëŒ€ë¶„ë¥˜ <span class="text-red-500">*</span></label>
        <select id="largeCategory" class="w-full border border-gray-300 px-3 py-2 rounded">
          <option value="">ì„ íƒí•˜ì„¸ìš”</option>
          <option th:each="category : ${largeCategories}"
                  th:value="${category.largeCode}"
                  th:text="${category.name}">
          </option>
        </select>
      </div>
      <div>
        <label class="block font-medium mb-1">ì¤‘ë¶„ë¥˜ <span class="text-red-500">*</span></label>
        <select id="mediumCategory" class="w-full border border-gray-300 px-3 py-2 rounded" disabled>
          <option value="">ì„ íƒí•˜ì„¸ìš”</option>
        </select>
      </div>
      <div>
        <label class="block font-medium mb-1">ì†Œë¶„ë¥˜ <span class="text-red-500">*</span></label>
        <select id="smallCategory" class="w-full border border-gray-300 px-3 py-2 rounded" disabled>
          <option value="">ì„ íƒí•˜ì„¸ìš”</option>
        </select>
      </div>
    </div>

    <!-- íˆë“  í•„ë“œë¡œ ìµœì¢… ì¹´í…Œê³ ë¦¬ ì½”ë“œ ì €ì¥ -->
    <input type="hidden" name="category" id="finalCategoryCode" />

    <!-- ì„ íƒëœ ì¹´í…Œê³ ë¦¬ í‘œì‹œ -->
    <div id="selectedCategoryDisplay" class="text-sm text-gray-600 hidden">
      ì„ íƒëœ ì¹´í…Œê³ ë¦¬: <span id="selectedCategoryText" class="font-medium text-blue-600"></span>
    </div>

    <!-- ë„ì„œ ì •ë³´ ì…ë ¥ -->
    <div class="grid md:grid-cols-2 gap-4">
      <div>
        <label class="block font-medium mb-1">ì±… ì œëª© <span class="text-red-500">*</span></label>
        <input type="text" name="title" class="w-full border border-gray-300 px-3 py-2 rounded" required />
      </div>
      <div>
        <label class="block font-medium mb-1">ì €ì <span class="text-red-500">*</span></label>
        <input type="text" name="author" class="w-full border border-gray-300 px-3 py-2 rounded" required />
      </div>
      <div>
        <label class="block font-medium mb-1">ì¶œíŒì‚¬ <span class="text-red-500">*</span></label>
        <input type="text" name="publisher" class="w-full border border-gray-300 px-3 py-2 rounded" required />
      </div>
      <div>
        <label class="block font-medium mb-1">ISBN <span class="text-red-500">*</span></label>
        <input type="text" name="isbn" class="w-full border border-gray-300 px-3 py-2 rounded" required
               placeholder="ì˜ˆ: 9788960773431 (10ìë¦¬ ë˜ëŠ” 13ìë¦¬ ìˆ«ì)" />
      </div>
      <div>
        <label class="block font-medium mb-1">ì¶œê°„ì¼ <span class="text-red-500">*</span></label>
        <input type="date" name="publishedAt" class="w-full border border-gray-300 px-3 py-2 rounded" required />
      </div>
      <div>
        <label class="block font-medium mb-1">ë„ì„œ ìœ„ì¹˜ <span class="text-red-500">*</span></label>
        <select name="location" class="w-full border border-gray-300 px-3 py-2 rounded" required>
          <option value="">ì„ íƒ</option>
          <option value="A-1">A-1</option>
          <option value="A-2">A-2</option>
          <option value="B-1">B-1</option>
          <option value="B-2">B-2</option>
          <option value="C-1">C-1</option>
          <option value="C-2">C-2</option>
          <option value="C-3">C-3</option>
        </select>
      </div>
    </div>

    <!-- ê¸°íƒ€ í•­ëª© -->
    <div class="grid md:grid-cols-3 gap-4">
      <div>
        <label class="block font-medium mb-1">ì¬ê³  ìˆ˜ëŸ‰ <span class="text-red-500">*</span></label>
        <input type="number" name="stock" min="0" max="9999" class="w-full border border-gray-300 px-3 py-2 rounded" required />
        <p class="text-sm text-gray-500 mt-1">ì…ë ¥í•œ ìˆ˜ëŸ‰ë§Œí¼ ê³ ìœ í•œ ë„ì„œ ì½”ë“œê°€ ìƒì„±ë©ë‹ˆë‹¤.</p>
      </div>
      <div class="flex items-center space-x-2 mt-8">
        <input type="checkbox" name="isAvailable" id="available" class="w-4 h-4 text-blue-600" checked />
        <label for="available" class="font-medium">ëŒ€ì—¬ ê°€ëŠ¥</label>
      </div>
      <div>
        <label class="block font-medium mb-1">í‘œì§€ ì´ë¯¸ì§€ URL <span class="text-red-500">*</span></label>
        <input type="url" name="cover" class="w-full border border-gray-300 px-3 py-2 rounded" required
               placeholder="ì˜ˆ: https://example.com/cover.jpg" />
      </div>
    </div>

    <!-- ë²„íŠ¼ -->
    <div class="flex justify-end space-x-3 pt-4">
      <button type="submit" class="px-5 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">í™•ì¸</button>
      <button type="button" onclick="history.back()" class="px-5 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400">ì·¨ì†Œ</button>
    </div>
  </form>
</main>

<!-- í‘¸í„° -->
<footer class="bg-white border-t mt-12">
  <div class="max-w-screen-xl mx-auto px-4 py-6 text-center text-sm text-gray-500">
    ìƒí˜¸: ë¶ë§¤ë‹ˆì € | ì „í™”: 010-7294-3724 | ì´ë©”ì¼: admin@bookmanager.com
  </div>
</footer>

<script>
  const largeSelect = document.getElementById('largeCategory');
  const mediumSelect = document.getElementById('mediumCategory');
  const smallSelect = document.getElementById('smallCategory');
  const finalCategoryCode = document.getElementById('finalCategoryCode');
  const selectedCategoryDisplay = document.getElementById('selectedCategoryDisplay');
  const selectedCategoryText = document.getElementById('selectedCategoryText');

  // CSRF í† í° ê°€ì ¸ì˜¤ê¸°
  const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
  const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');

  // ëŒ€ë¶„ë¥˜ ì„ íƒ ì‹œ ì¤‘ë¶„ë¥˜ ì¡°íšŒ
  largeSelect.addEventListener('change', function() {
    const largeCode = this.value;

    // ì¤‘ë¶„ë¥˜, ì†Œë¶„ë¥˜ ì´ˆê¸°í™”
    mediumSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
    smallSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
    mediumSelect.disabled = !largeCode;
    smallSelect.disabled = true;
    finalCategoryCode.value = '';
    selectedCategoryDisplay.classList.add('hidden');

    if (largeCode) {
      // AJAXë¡œ ì¤‘ë¶„ë¥˜ ì¡°íšŒ
      const headers = {
        'Content-Type': 'application/json'
      };

      // CSRF í† í°ì´ ìˆìœ¼ë©´ í—¤ë”ì— ì¶”ê°€
      if (csrfToken && csrfHeader) {
        headers[csrfHeader] = csrfToken;
      }

      fetch(`/admin/api/categories/medium/${largeCode}`, {
        method: 'GET',
        headers: headers
      })
              .then(response => {
                if (!response.ok) {
                  throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
              })
              .then(categories => {
                categories.forEach(category => {
                  const option = document.createElement('option');
                  option.value = category.mediumCode;
                  option.textContent = category.name;
                  option.dataset.largeCode = category.largeCode;
                  mediumSelect.appendChild(option);
                });
              })
              .catch(error => {
                console.error('ì¤‘ë¶„ë¥˜ ì¡°íšŒ ì‹¤íŒ¨:', error);
                alert('ì¤‘ë¶„ë¥˜ ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
              });
    }
  });

  // ì¤‘ë¶„ë¥˜ ì„ íƒ ì‹œ ì†Œë¶„ë¥˜ ì¡°íšŒ
  mediumSelect.addEventListener('change', function() {
    const largeCode = largeSelect.value;
    const mediumCode = this.value;

    // ì†Œë¶„ë¥˜ ì´ˆê¸°í™”
    smallSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
    smallSelect.disabled = !mediumCode;
    finalCategoryCode.value = '';
    selectedCategoryDisplay.classList.add('hidden');

    if (largeCode && mediumCode) {
      // AJAXë¡œ ì†Œë¶„ë¥˜ ì¡°íšŒ
      const headers = {
        'Content-Type': 'application/json'
      };

      // CSRF í† í°ì´ ìˆìœ¼ë©´ í—¤ë”ì— ì¶”ê°€
      if (csrfToken && csrfHeader) {
        headers[csrfHeader] = csrfToken;
      }

      fetch(`/admin/api/categories/small/${largeCode}/${mediumCode}`, {
        method: 'GET',
        headers: headers
      })
              .then(response => {
                if (!response.ok) {
                  throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
              })
              .then(categories => {
                categories.forEach(category => {
                  const option = document.createElement('option');
                  option.value = category.smallCode;
                  option.textContent = category.name;
                  option.dataset.largeCode = category.largeCode;
                  option.dataset.mediumCode = category.mediumCode;
                  option.dataset.fullCode = category.fullCode;
                  smallSelect.appendChild(option);
                });
              })
              .catch(error => {
                console.error('ì†Œë¶„ë¥˜ ì¡°íšŒ ì‹¤íŒ¨:', error);
                alert('ì†Œë¶„ë¥˜ ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
              });
    }
  });

  // ì†Œë¶„ë¥˜ ì„ íƒ ì‹œ ìµœì¢… ì¹´í…Œê³ ë¦¬ ì½”ë“œ ì„¤ì •
  smallSelect.addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];

    if (selectedOption.value) {
      const fullCode = selectedOption.dataset.fullCode;
      finalCategoryCode.value = fullCode;

      // ì„ íƒëœ ì¹´í…Œê³ ë¦¬ í‘œì‹œ
      const largeName = largeSelect.options[largeSelect.selectedIndex].text;
      const mediumName = mediumSelect.options[mediumSelect.selectedIndex].text;
      const smallName = selectedOption.text;

      selectedCategoryText.textContent = `${largeName} > ${mediumName} > ${smallName} (${fullCode})`;
      selectedCategoryDisplay.classList.remove('hidden');
    } else {
      finalCategoryCode.value = '';
      selectedCategoryDisplay.classList.add('hidden');
    }
  });

  // í¼ ì œì¶œ ì‹œ ê²€ì¦
  document.querySelector('form').addEventListener('submit', function(e) {
    const isbn = document.querySelector('input[name="isbn"]').value;
    const category = finalCategoryCode.value;

    // ISBN ê¸¸ì´ ê²€ì¦
    if (isbn && !/^\d{10}$|^\d{13}$/.test(isbn)) {
      e.preventDefault();
      alert('ISBNì€ 10ìë¦¬ ë˜ëŠ” 13ìë¦¬ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.');
      return false;
    }

    // ì¹´í…Œê³ ë¦¬ ì„ íƒ ê²€ì¦
    if (!category) {
      e.preventDefault();
      alert('ì¹´í…Œê³ ë¦¬ë¥¼ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return false;
    }

    // í¼ ì œì¶œ ì‹œ ë¡œë”© í‘œì‹œ
    const submitButton = this.querySelector('button[type="submit"]');
    const originalText = submitButton.textContent;
    submitButton.textContent = 'ë“±ë¡ ì¤‘...';
    submitButton.disabled = true;

    // 3ì´ˆ í›„ ì›ë˜ ìƒíƒœë¡œ ë³µì› (ì—ëŸ¬ ë°œìƒ ì‹œ ëŒ€ë¹„)
    setTimeout(() => {
      submitButton.textContent = originalText;
      submitButton.disabled = false;
    }, 3000);
  });

  // ì„±ê³µ ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ 3ì´ˆ í›„ ë¦¬ìŠ¤íŠ¸ë¡œ ì´ë™
  window.addEventListener('DOMContentLoaded', function() {
    const messageElement = document.querySelector('.bg-green-100');
    if (messageElement) {
      setTimeout(() => {
        alert('ì •ìƒì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
        window.location.href = '/admin/v1/books';
      }, 500);
    }
  });
</script>
</body>
</html>