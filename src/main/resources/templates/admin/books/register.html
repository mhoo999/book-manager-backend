<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
  <title>ë¶ë§¤ë‹ˆì €</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    @keyframes fade {
      0% {
        opacity: 0.4;
      }
      100% {
        opacity: 1;
      }
    }

    header{position: relative;}
    header>.bg_lnb{
      display: none;
      position: absolute;
      left: 0;
      top: 72px;
      width: 100%;
      height: 120px;
      background-color: rgba(59, 130, 246, 0.15);
      border-top: 3px solid #3b82f6;
      border-bottom: 1px solid #bfdbfe;
      animation: fade 0.3s;
    }

    .container{
      position: relative;
    }
    .container>nav{
      position: absolute;
      right: 0;
      top: 32px;
    }

    .container>nav .lnb{
      display: none;
      margin-top: 32px;
      animation: fade 0.3s;
    }
    .container>nav .lnb>li>a{
      display: block;
      height: 30px;
      line-height: 30px;

    }
    .container>nav .lnb>li>a:hover{
      color: #fff;
      font-weight: 800;
      background-color: #3b82f6;
    }

    .error-message {
      color: #dc2626;
      font-size: 0.875rem;
      margin-top: 0.25rem;
    }

    /* íŒŒì¼ ì—…ë¡œë“œ ìŠ¤íƒ€ì¼ */
    .file-upload-area {
      border: 2px dashed #cbd5e0;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .file-upload-area:hover {
      border-color: #3b82f6;
      background-color: #f8fafc;
    }

    .file-upload-area.drag-over {
      border-color: #3b82f6;
      background-color: #eff6ff;
    }

    .preview-image {
      max-width: 200px;
      max-height: 300px;
      object-fit: cover;
      border-radius: 8px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

  </style>
  <script src="/Global/js/GlobalNavBarHover.js" defer></script>
</head>
<body class="bg-gray-50">
<!-- í—¤ë” -->
<header th:replace="~{fragments/header :: siteHeader}"></header>

<!-- ë³¸ë¬¸ -->
<main class="max-w-screen-xl mx-auto px-4 py-8">
  <h2 class="text-2xl font-bold mb-6">ğŸ“š ë„ì„œë“±ë¡</h2>

  <!-- ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ -->
  <div th:if="${message}" class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4" role="alert">
    <span class="block sm:inline" th:text="${message}"></span>
  </div>

  <!-- ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ -->
  <div th:if="${errorMessage}" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4" role="alert">
    <span class="block sm:inline" th:text="${errorMessage}"></span>
  </div>

  <!-- íŒŒì¼ ì—…ë¡œë“œë¥¼ ìœ„í•´ enctype ì¶”ê°€ -->
  <form th:action="@{/admin/v1/books/register}" method="post" enctype="multipart/form-data" class="bg-white p-6 rounded border border-gray-300 shadow space-y-6">

    <!-- ì¹´í…Œê³ ë¦¬ -->
    <div class="grid md:grid-cols-3 gap-4">
      <div>
        <label class="block font-medium mb-1">ëŒ€ë¶„ë¥˜ <span class="text-red-500">*</span></label>
        <select id="largeCategory" class="w-full border border-gray-300 px-3 py-2 rounded">
          <option value="">ì„ íƒí•˜ì„¸ìš”</option>
          <option th:each="category : ${largeCategories}"
                  th:value="${category.largeCode}"
                  th:text="${category.name}">
          </option>
        </select>
      </div>
      <div>
        <label class="block font-medium mb-1">ì¤‘ë¶„ë¥˜ <span class="text-red-500">*</span></label>
        <select id="mediumCategory" class="w-full border border-gray-300 px-3 py-2 rounded" disabled>
          <option value="">ì„ íƒí•˜ì„¸ìš”</option>
        </select>
      </div>
      <div>
        <label class="block font-medium mb-1">ì†Œë¶„ë¥˜ <span class="text-red-500">*</span></label>
        <select id="smallCategory" class="w-full border border-gray-300 px-3 py-2 rounded" disabled>
          <option value="">ì„ íƒí•˜ì„¸ìš”</option>
        </select>
      </div>
    </div>

    <!-- íˆë“  í•„ë“œë¡œ ìµœì¢… ì¹´í…Œê³ ë¦¬ ì½”ë“œ ì €ì¥ -->
    <input type="hidden" name="category" id="finalCategoryCode" />

    <!-- ì„ íƒëœ ì¹´í…Œê³ ë¦¬ í‘œì‹œ -->
    <div id="selectedCategoryDisplay" class="text-sm text-gray-600 hidden">
      ì„ íƒëœ ì¹´í…Œê³ ë¦¬: <span id="selectedCategoryText" class="font-medium text-blue-600"></span>
    </div>

    <!-- ë„ì„œ ì •ë³´ ì…ë ¥ -->
    <div class="grid md:grid-cols-2 gap-4">
      <div>
        <label class="block font-medium mb-1">ì±… ì œëª© <span class="text-red-500">*</span></label>
        <input type="text" name="title" class="w-full border border-gray-300 px-3 py-2 rounded" required />
      </div>
      <div>
        <label class="block font-medium mb-1">ì €ì <span class="text-red-500">*</span></label>
        <input type="text" name="author" class="w-full border border-gray-300 px-3 py-2 rounded" required />
      </div>
      <div>
        <label class="block font-medium mb-1">ì¶œíŒì‚¬ <span class="text-red-500">*</span></label>
        <input type="text" name="publisher" class="w-full border border-gray-300 px-3 py-2 rounded" required />
      </div>
      <div>
        <label class="block font-medium mb-1">ISBN <span class="text-red-500">*</span></label>
        <input type="text" name="isbn" class="w-full border border-gray-300 px-3 py-2 rounded" required
               placeholder="ì˜ˆ: 9788960773431 (10ìë¦¬ ë˜ëŠ” 13ìë¦¬ ìˆ«ì)" />
      </div>
      <div>
        <label class="block font-medium mb-1">ì¶œê°„ì¼ <span class="text-red-500">*</span></label>
        <input type="date" name="publishedAt" class="w-full border border-gray-300 px-3 py-2 rounded" required />
      </div>
      <div>
        <label class="block font-medium mb-1">ë„ì„œ ìœ„ì¹˜ <span class="text-red-500">*</span></label>
        <select name="location" class="w-full border border-gray-300 px-3 py-2 rounded" required>
          <option value="">ì„ íƒ</option>
          <option value="A-1">A-1</option>
          <option value="A-2">A-2</option>
          <option value="B-1">B-1</option>
          <option value="B-2">B-2</option>
          <option value="C-1">C-1</option>
          <option value="C-2">C-2</option>
          <option value="C-3">C-3</option>
        </select>
      </div>
    </div>

    <!-- ê¸°íƒ€ í•­ëª© -->
    <div class="grid md:grid-cols-2 gap-4">
      <div>
        <label class="block font-medium mb-1">ì¬ê³  ìˆ˜ëŸ‰ <span class="text-red-500">*</span></label>
        <input type="number" name="stock" min="0" max="9999" class="w-full border border-gray-300 px-3 py-2 rounded" required />
        <p class="text-sm text-gray-500 mt-1">ì…ë ¥í•œ ìˆ˜ëŸ‰ë§Œí¼ ê³ ìœ í•œ ë„ì„œ ì½”ë“œê°€ ìƒì„±ë©ë‹ˆë‹¤.</p>
      </div>
      <div class="flex items-center space-x-2 mt-8">
        <input type="checkbox" name="isAvailable" id="available" class="w-4 h-4 text-blue-600" checked />
        <label for="available" class="font-medium">ëŒ€ì—¬ ê°€ëŠ¥</label>
      </div>
    </div>

    <!-- í‘œì§€ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì„¹ì…˜ -->
    <div class="space-y-4">
      <label class="block font-medium mb-1">í‘œì§€ ì´ë¯¸ì§€ <span class="text-red-500">*</span></label>

      <!-- íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ -->
      <div class="file-upload-area" id="fileUploadArea">
        <input type="file" name="coverFile" id="coverFile" accept="image/*" class="hidden" required />
        <div id="uploadPrompt">
          <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" stroke="currentColor" fill="none" viewBox="0 0 48 48">
            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
          <p class="text-gray-600 mb-2">í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ë“œë˜ê·¸í•´ì„œ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
          <p class="text-sm text-gray-500">JPG, PNG, GIF, WebP (ìµœëŒ€ 5MB)</p>
        </div>

        <!-- ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ -->
        <div id="imagePreview" class="hidden">
          <img id="previewImg" class="preview-image mx-auto mb-4" />
          <p id="fileName" class="text-sm text-gray-600 mb-2"></p>
          <button type="button" id="removeImage" class="text-red-600 hover:text-red-800 text-sm">
            âœ• ì´ë¯¸ì§€ ì œê±°
          </button>
        </div>
      </div>

      <!-- ë˜ëŠ” URL ì…ë ¥ -->
      <div class="text-center text-gray-500 text-sm">ë˜ëŠ”</div>
      <div>
        <label class="block font-medium mb-1">í‘œì§€ ì´ë¯¸ì§€ URL</label>
        <input type="url" name="coverUrl" id="coverUrl" class="w-full border border-gray-300 px-3 py-2 rounded"
               placeholder="ì˜ˆ: https://example.com/cover.jpg" />
        <p class="text-sm text-gray-500 mt-1">íŒŒì¼ ì—…ë¡œë“œì™€ URL ì¤‘ í•˜ë‚˜ë§Œ ì…ë ¥í•˜ì„¸ìš”.</p>
      </div>
    </div>

    <!-- ì„¤ëª… -->
    <div>
      <label class="block font-medium mb-1">ë„ì„œ ì„¤ëª…</label>
      <textarea name="description" rows="4" class="w-full border border-gray-300 px-3 py-2 rounded"
                placeholder="ë„ì„œì— ëŒ€í•œ ê°„ë‹¨í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
    </div>

    <!-- ë²„íŠ¼ -->
    <div class="flex justify-end space-x-3 pt-4">
      <button type="submit" class="px-5 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">í™•ì¸</button>
      <button type="button" onclick="history.back()" class="px-5 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400">ì·¨ì†Œ</button>
    </div>
  </form>
</main>

<!-- í‘¸í„° -->
<footer class="bg-white border-t mt-12">
  <div class="max-w-screen-xl mx-auto px-4 py-6 text-center text-sm text-gray-500">
    ìƒí˜¸: ë¶ë§¤ë‹ˆì € | ì „í™”: 010-7294-3724 | ì´ë©”ì¼: admin@bookmanager.com
  </div>
</footer>

<script>
  const largeSelect = document.getElementById('largeCategory');
  const mediumSelect = document.getElementById('mediumCategory');
  const smallSelect = document.getElementById('smallCategory');
  const finalCategoryCode = document.getElementById('finalCategoryCode');
  const selectedCategoryDisplay = document.getElementById('selectedCategoryDisplay');
  const selectedCategoryText = document.getElementById('selectedCategoryText');

  // íŒŒì¼ ì—…ë¡œë“œ ê´€ë ¨ ìš”ì†Œë“¤
  const fileUploadArea = document.getElementById('fileUploadArea');
  const coverFileInput = document.getElementById('coverFile');
  const uploadPrompt = document.getElementById('uploadPrompt');
  const imagePreview = document.getElementById('imagePreview');
  const previewImg = document.getElementById('previewImg');
  const fileName = document.getElementById('fileName');
  const removeImageBtn = document.getElementById('removeImage');
  const coverUrlInput = document.getElementById('coverUrl');

  // CSRF í† í° ê°€ì ¸ì˜¤ê¸°
  const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
  const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');

  // íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ í´ë¦­ ì´ë²¤íŠ¸
  fileUploadArea.addEventListener('click', function() {
    if (!imagePreview.classList.contains('hidden')) return;
    coverFileInput.click();
  });

  // íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸
  coverFileInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      handleFileUpload(file);
      coverUrlInput.value = ''; // URL ì…ë ¥ ì´ˆê¸°í™”
    }
  });

  // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸
  fileUploadArea.addEventListener('dragover', function(e) {
    e.preventDefault();
    fileUploadArea.classList.add('drag-over');
  });

  fileUploadArea.addEventListener('dragleave', function(e) {
    e.preventDefault();
    fileUploadArea.classList.remove('drag-over');
  });

  fileUploadArea.addEventListener('drop', function(e) {
    e.preventDefault();
    fileUploadArea.classList.remove('drag-over');

    const files = e.dataTransfer.files;
    if (files.length > 0) {
      const file = files[0];
      if (file.type.startsWith('image/')) {
        coverFileInput.files = files;
        handleFileUpload(file);
        coverUrlInput.value = ''; // URL ì…ë ¥ ì´ˆê¸°í™”
      } else {
        alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
      }
    }
  });

  // íŒŒì¼ ì²˜ë¦¬ í•¨ìˆ˜
  function handleFileUpload(file) {
    // íŒŒì¼ í¬ê¸° ê²€ì¦ (5MB)
    if (file.size > 5 * 1024 * 1024) {
      alert('íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. ìµœëŒ€ 5MBê¹Œì§€ í—ˆìš©ë©ë‹ˆë‹¤.');
      return;
    }

    // íŒŒì¼ íƒ€ì… ê²€ì¦
    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
    if (!allowedTypes.includes(file.type)) {
      alert('ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤. JPG, PNG, GIF, WebPë§Œ í—ˆìš©ë©ë‹ˆë‹¤.');
      return;
    }

    // ë¯¸ë¦¬ë³´ê¸° ìƒì„±
    const reader = new FileReader();
    reader.onload = function(e) {
      previewImg.src = e.target.result;
      fileName.textContent = file.name;
      uploadPrompt.classList.add('hidden');
      imagePreview.classList.remove('hidden');
    };
    reader.readAsDataURL(file);
  }

  // ì´ë¯¸ì§€ ì œê±° ë²„íŠ¼
  removeImageBtn.addEventListener('click', function(e) {
    e.stopPropagation();
    coverFileInput.value = '';
    uploadPrompt.classList.remove('hidden');
    imagePreview.classList.add('hidden');
  });

  // URL ì…ë ¥ ì‹œ íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
  coverUrlInput.addEventListener('input', function() {
    if (this.value.trim()) {
      coverFileInput.value = '';
      uploadPrompt.classList.remove('hidden');
      imagePreview.classList.add('hidden');
    }
  });

  // ëŒ€ë¶„ë¥˜ ì„ íƒ ì‹œ ì¤‘ë¶„ë¥˜ ì¡°íšŒ
  largeSelect.addEventListener('change', function() {
    const largeCode = this.value;

    // ì¤‘ë¶„ë¥˜, ì†Œë¶„ë¥˜ ì´ˆê¸°í™”
    mediumSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
    smallSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
    mediumSelect.disabled = !largeCode;
    smallSelect.disabled = true;
    finalCategoryCode.value = '';
    selectedCategoryDisplay.classList.add('hidden');

    if (largeCode) {
      // AJAXë¡œ ì¤‘ë¶„ë¥˜ ì¡°íšŒ
      const headers = {
        'Content-Type': 'application/json'
      };

      if (csrfToken && csrfHeader) {
        headers[csrfHeader] = csrfToken;
      }

      fetch(`/admin/api/categories/medium/${largeCode}`, {
        method: 'GET',
        headers: headers
      })
              .then(response => {
                if (!response.ok) {
                  throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
              })
              .then(categories => {
                categories.forEach(category => {
                  const option = document.createElement('option');
                  option.value = category.mediumCode;
                  option.textContent = category.name;
                  option.dataset.largeCode = category.largeCode;
                  mediumSelect.appendChild(option);
                });
              })
              .catch(error => {
                console.error('ì¤‘ë¶„ë¥˜ ì¡°íšŒ ì‹¤íŒ¨:', error);
                alert('ì¤‘ë¶„ë¥˜ ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
              });
    }
  });

  // ì¤‘ë¶„ë¥˜ ì„ íƒ ì‹œ ì†Œë¶„ë¥˜ ì¡°íšŒ
  mediumSelect.addEventListener('change', function() {
    const largeCode = largeSelect.value;
    const mediumCode = this.value;

    // ì†Œë¶„ë¥˜ ì´ˆê¸°í™”
    smallSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
    smallSelect.disabled = !mediumCode;
    finalCategoryCode.value = '';
    selectedCategoryDisplay.classList.add('hidden');

    if (largeCode && mediumCode) {
      const headers = {
        'Content-Type': 'application/json'
      };

      if (csrfToken && csrfHeader) {
        headers[csrfHeader] = csrfToken;
      }

      fetch(`/admin/api/categories/small/${largeCode}/${mediumCode}`, {
        method: 'GET',
        headers: headers
      })
              .then(response => {
                if (!response.ok) {
                  throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
              })
              .then(categories => {
                categories.forEach(category => {
                  const option = document.createElement('option');
                  option.value = category.smallCode;
                  option.textContent = category.name;
                  option.dataset.largeCode = category.largeCode;
                  option.dataset.mediumCode = category.mediumCode;
                  option.dataset.fullCode = category.fullCode;
                  smallSelect.appendChild(option);
                });
              })
              .catch(error => {
                console.error('ì†Œë¶„ë¥˜ ì¡°íšŒ ì‹¤íŒ¨:', error);
                alert('ì†Œë¶„ë¥˜ ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
              });
    }
  });

  // ì†Œë¶„ë¥˜ ì„ íƒ ì‹œ ìµœì¢… ì¹´í…Œê³ ë¦¬ ì½”ë“œ ì„¤ì •
  smallSelect.addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];

    if (selectedOption.value) {
      const fullCode = selectedOption.dataset.fullCode;
      finalCategoryCode.value = fullCode;

      // ì„ íƒëœ ì¹´í…Œê³ ë¦¬ í‘œì‹œ
      const largeName = largeSelect.options[largeSelect.selectedIndex].text;
      const mediumName = mediumSelect.options[mediumSelect.selectedIndex].text;
      const smallName = selectedOption.text;

      selectedCategoryText.textContent = `${largeName} > ${mediumName} > ${smallName} (${fullCode})`;
      selectedCategoryDisplay.classList.remove('hidden');
    } else {
      finalCategoryCode.value = '';
      selectedCategoryDisplay.classList.add('hidden');
    }
  });

  // í¼ ì œì¶œ ì‹œ ê²€ì¦
  document.querySelector('form').addEventListener('submit', function(e) {
    const isbn = document.querySelector('input[name="isbn"]').value;
    const category = finalCategoryCode.value;
    const coverFile = coverFileInput.files[0];
    const coverUrl = coverUrlInput.value.trim();

    // ISBN ê¸¸ì´ ê²€ì¦
    if (isbn && !/^\d{10}$|^\d{13}$/.test(isbn)) {
      e.preventDefault();
      alert('ISBNì€ 10ìë¦¬ ë˜ëŠ” 13ìë¦¬ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.');
      return false;
    }

    // ì¹´í…Œê³ ë¦¬ ì„ íƒ ê²€ì¦
    if (!category) {
      e.preventDefault();
      alert('ì¹´í…Œê³ ë¦¬ë¥¼ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return false;
    }

    // í‘œì§€ ì´ë¯¸ì§€ ê²€ì¦ (íŒŒì¼ ë˜ëŠ” URL ì¤‘ í•˜ë‚˜ëŠ” í•„ìˆ˜)
    if (!coverFile && !coverUrl) {
      e.preventDefault();
      alert('í‘œì§€ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ê±°ë‚˜ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return false;
    }

    // í¼ ì œì¶œ ì‹œ ë¡œë”© í‘œì‹œ
    const submitButton = this.querySelector('button[type="submit"]');
    const originalText = submitButton.textContent;
    submitButton.textContent = 'ë“±ë¡ ì¤‘...';
    submitButton.disabled = true;

    // 3ì´ˆ í›„ ì›ë˜ ìƒíƒœë¡œ ë³µì› (ì—ëŸ¬ ë°œìƒ ì‹œ ëŒ€ë¹„)
    setTimeout(() => {
      submitButton.textContent = originalText;
      submitButton.disabled = false;
    }, 3000);
  });

  // ì„±ê³µ ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ 3ì´ˆ í›„ ë¦¬ìŠ¤íŠ¸ë¡œ ì´ë™
  window.addEventListener('DOMContentLoaded', function() {
    const messageElement = document.querySelector('.bg-green-100');
    if (messageElement) {
      setTimeout(() => {
        alert('ì •ìƒì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
        window.location.href = '/admin/v1/books';
      }, 500);
    }
  });
</script>
</body>
</html>